import pandas as pd
from TM1py.Services import TM1Service

# Define the dimension names in the order that they appear in your cube keys.
# You can easily change these names as needed.
dimensions = ["Item", "Location", "Customer", "Month", "Year", "Sales"]

# TM1 Connection Parameters (update these with your actual TM1 server details)
tm1_address = "your_tm1_server_address"  # e.g., "tm1.mycompany.com"
tm1_port = "50439"
tm1_user = "admin"
tm1_password = "apple"
tm1_ssl = False

cube_name = "InputCube"
view_name = "Default"

with TM1Service(address=tm1_address, port=tm1_port, user=tm1_user,
                password=tm1_password, ssl=tm1_ssl) as tm1:
    
    # Retrieve the raw data from the specified cube view.
    raw_data = tm1.cubes.cells.execute_view(cube_name=cube_name, view_name=view_name, private=False)
    print("Raw data from view:")
    print(raw_data)
    
    # Process the raw_data into rows for a DataFrame.
    rows = []
    for key, cell in raw_data.items():
        # Check that the key has at least as many elements as defined in the dimensions list.
        if len(key) < len(dimensions):
            print("Warning: key has fewer coordinates than expected:", key)
            continue
        
        # Build a row dictionary using the dimensions list.
        row = {}
        for idx, dim_name in enumerate(dimensions):
            # Simple processing: split the coordinate by whitespace and take the last token.
            element_value = key[idx].split()[-1].strip()
            row[dim_name] = element_value
        
        # For the Sales dimension, use the cell's Value if present.
        sales_val = cell.get("Value")
        if sales_val is None:
            try:
                sales_val = float(row["Sales"])
            except Exception:
                sales_val = row["Sales"]
        row["Sales"] = sales_val
        
        rows.append(row)
    
    # Create a pandas DataFrame from the rows.
    df = pd.DataFrame(rows)
    print("DataFrame shape:", df.shape)
    print("DataFrame preview:")
    print(df.head())
